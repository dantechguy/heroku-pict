<!DOCTYPE html>
<html>
<head>
  <title>danwb-pict</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style type="text/css">
    body {
      margin: 0;
      text-align: center;
    }
  </style>
</head>
<body>

  <div id='content'>
  </div>

<script src='https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js'></script>
<script type='text/javascript'>
  var contentDom = document.querySelector('#content');

  var socket = io();

  var currentUrlPath = window.location.pathname;
  var roomId = currentUrlPath.substring(1);
  socket.emit('newUser', roomId);


  socket.on('errorMessage', function(errorMessage) {
    contentDom.innerHTML = errorMessage;
  });

  socket.on('generateLobby', function(data) {
    contentDom.innerHTML = `<input placeholder='Name' type='text' id='name'><button onclick='playerReady();' id='ready'>Ready</button>`;
  });

  function playerReady() {
    let userName = document.querySelector('#name').value;
    socket.emit('playerReadyWithName', userName);
    contentDom.innerHTML = '';
  };

  socket.on('generateInitialPrompt', function() {
    contentDom.innerHTML = `<input placeholder='Promt' type='text' id='prompt'><button onclick='submitPrompt();' id='submit'>Submit</button>`;
  });

  function submitPrompt() {
    let prompt = document.querySelector('#prompt').value;
    socket.emit('submitPrompt', prompt);
    contentDom.innerHTML = '';
  };

  socket.on('receivePromptAndStartDrawing', function(prompt) {

    contentDom.innerHTML = `<div id='container' style=';font-size: 0;text-align: center;background-color: #ddd;'><div id=topbar style='font-size: 25px;user-select: none;'><button id="clear" style='height: 40px;'>clear</button><span style='height: 40px;'>` + prompt + `</span><button id="submit" style='height: 40px;'>submit</button></div><canvas style='background-color: #fff;max-width: 100vw;max-height: calc(100vh - 40px);'></canvas></div>`;

    eval(`var width=1e3,height=2e3,canvasDom=document.querySelector("canvas");canvasDom.width=width,canvasDom.height=height;var context=canvasDom.getContext("2d");context.lineWidth="40",context.lineJoin="round",context.lineCap="round";var drawingJson=[],mouseDown=!1,clearDom=document.querySelector("#clear"),submitDom=document.querySelector("#submit");function cancelTouchMove(e){e.preventDefault()}function scaleXY(e){let t=width/canvasDom.clientWidth;if(["touchstart","touchmove"].includes(e.type)){let o=e.touches[0];var n=e.target.getBoundingClientRect();return{x:(o.clientX-n.left)*t,y:(o.clientY-n.top)*t}}return{x:e.offsetX*t,y:e.offsetY*t}}function drawStart(e){let t=scaleXY(e),n=t.x,o=t.y;drawingJson.push([{x:n,y:o}]),mouseDown=!0}function drawMove(e){if(e.preventDefault(),mouseDown){let t=scaleXY(e),n=t.x,o=t.y;drawingJson.slice(-1)[0].push({x:n,y:o})}}function drawEnd(e){mouseDown=!1}function updateLine(){context.clearRect(0,0,canvasDom.width,canvasDom.height);for(let e in drawingJson){let t=drawingJson[e];context.beginPath(),context.moveTo(t[0].x,t[0].y);for(let e in t.slice(1)){let n=t[e];context.lineTo(n.x,n.y)}context.stroke()}requestAnimationFrame(updateLine)}document.addEventListener("touchmove",cancelTouchMove,{passive:!1}),canvasDom.addEventListener("mousedown",drawStart,{passive:!1}),canvasDom.addEventListener("touchstart",drawStart,{passive:!1}),canvasDom.addEventListener("mousemove",drawMove,{passive:!1}),canvasDom.addEventListener("touchmove",drawMove,{passive:!1}),canvasDom.addEventListener("mouseleave",drawEnd),canvasDom.addEventListener("mouseup",drawEnd),canvasDom.addEventListener("touchend",drawEnd),canvasDom.addEventListener("touchcancel",drawEnd),clearDom.onclick=function(){drawingJson=[]},submitDom.onclick=function(){contentDom.innerHTML="",document.removeEventListener("touchmove",cancelTouchMove),socket.emit("submitDrawing",drawingJson)},requestAnimationFrame(updateLine)`);
  });

socket.on('receiveDrawingAndStartGuessing', function(drawingArray) {
  contentDom.innerHTML = `<div id='container' style='font-size: 0;text-align: center;background-color: #ddd;'><div id=topbar style='font-size: 25px;user-select: none;'><input placeholder='Guess' type='text' id='guess' style='height: 40px; border: none; padding: 0;'><button id="submit" style='height: 40px;'>submit</button></div><canvas style='background-color: #fff;max-width: 100vw;max-height: calc(100vh - 40px);'></canvas></div>`;

  eval(`var width=1000;var height=2000;var canvasDom=document.querySelector('canvas');canvasDom.width=width;canvasDom.height=height;var context=canvasDom.getContext('2d');context.lineWidth='40';context.lineJoin='round';context.lineCap='round';var inputDom=document.querySelector('#guess');var submitDom=document.querySelector('#submit');function drawPicture(drawingArray){for(let lineKey in drawingArray){let line=drawingArray[lineKey];context.beginPath();context.moveTo(line[0].x,line[0].y);for(let segmentKey in line.slice(1)){let segment=line[segmentKey];context.lineTo(segment.x,segment.y)};context.stroke()}};submitDom.onclick=function(){contentDom.innerHTML='';let guess=inputDom.value;socket.emit('submitPrompt',guess)};drawPicture(` + arrayContainingJsonToString(drawingArray) + `)`)
});

function arrayContainingJsonToString(array) {
  let listOfStringItems = []
  for (let i in array) {
    let currentItem = array[i];
    if (typeof currentItem === 'object') {
      if (Array.isArray(currentItem)) {
        listOfStringItems.push(arrayContainingJsonToString(currentItem));
      } else { // json
        listOfStringItems.push(JSON.stringify(currentItem));
      }
    };
  };
  return '[' + listOfStringItems.toString() + ']';
}

socket.on('generateChainReaction', function(chainReactionData) {
  htmlContent = '';
  jsContent = `function drawPicture(drawingArray,canvasId){let canvas=document.querySelector(canvasId);let context=canvas.getContext('2d');context.lineWidth='40';context.lineJoin='round';context.lineCap='round';for(let lineKey in drawingArray){let line=drawingArray[lineKey];context.beginPath();context.moveTo(line[0].x,line[0].y);for(let segmentKey in line.slice(1)){let segment=line[segmentKey];context.lineTo(segment.x,segment.y)};context.stroke()}};let tempCanvas;`;

  for (let roundNumber in chainReactionData) {
    let roundData = chainReactionData[roundNumber];

    let authorName = roundData.authorName;
    let guess = roundData.guess;
    let artistName = roundData.artistName;
    let drawingArray = roundData.drawingArray;

    roundHtmlContent = authorName + ' guessed ' + guess + '<br>so ' + artistName + ' drew:<br>' + `<canvas id='canvas` + roundNumber + `' style='background-color: #fff;max-width: 100vw;max-height: calc(100vh - 40px);'></canvas><br>`;

    roundJsContent = `tempCanvas = document.querySelector('#canvas` + roundNumber + `');tempCanvas.width=1000;tempCanvas.height=2000;drawPicture(` + arrayContainingJsonToString(drawingArray) + `, '#canvas` + roundNumber + `');`;

    htmlContent += roundHtmlContent;
    jsContent += roundJsContent;
  };
  contentDom.innerHTML = `<div id='container' style='font-size: 25px;text-align: center;background-color: #ddd;'>` + htmlContent + `</div>`;

  eval(jsContent)
});


</script>
</body>
</html>


<!--

function drawPicture(drawingArray, canvasId) {
  let canvas = document.querySelector('canvasId');
  let context = canvas.getContext('2d');

  for (let lineKey in drawingArray) {
    let line = drawingArray[lineKey];

    context.beginPath();
    context.moveTo(line[0].x, line[0].y);
    for (let segmentKey in line.slice(1)) {
      let segment = line[segmentKey];
      context.lineTo(segment.x, segment.y)
    };
    context.stroke();
  };
};